name: Recommender Build

on:
  workflow_dispatch

jobs:
  build:
    name: Build recommender with WireMock
    runs-on: ubuntu-latest

    services:
      wiremock:
        image: wiremock/wiremock:3.3.1
        ports:
          - 8080:8080

    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Upload WireMock mappings
        run: |
          for f in .github/wiremock/mappings/*.json; do
            curl -s -X POST http://localhost:8080/__admin/mappings \
                -H "Content-Type: application/json" \
                --data @"$f"
          done    

      - name: Build recommender with mocked services
        env:
          TEASTORE_REGISTRY_URL: http://localhost:8080
          TEASTORE_PERSISTENCE_URL: http://localhost:8080
        run: |
          mvn clean install -pl services/tools.descartes.teastore.recommender -am

          GIT_BRANCH=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
          echo "GIT_BRANCH=${GIT_BRANCH}" >> ${GITHUB_ENV}

          sed -i "s/teastore-base:latest/teastore-base:${GIT_BRANCH}/g" services/tools.descartes.teastore.recommender/Dockerfile

      - name: Build teastore-recommender Docker image
        uses: docker/build-push-action@v2
        with:
          context: ./services/tools.descartes.teastore.recommender
          push: false
          tags: descartesresearch/teastore-recommender:ci

  loadtest:
    name: Locust load test
    runs-on: ubuntu-latest
    needs: build

    services:
      wiremock:
        image: wiremock/wiremock:3.3.1
        ports:
          - 8080:8080

    steps:
      - uses: actions/checkout@v4

      - name: Start recommender container
        run: |
          docker run -d --name teastore-recommender -p 8081:8080 -e TEASTORE_REGISTRY_URL=http://host.docker.internal:8080 descartesresearch/teastore-recommender:ci

      - name: Upload WireMock mappings
        run: |
          for f in .github/wiremock/mappings/*.json; do
            curl -s -X POST http://localhost:8080/__admin/mappings -H "Content-Type: application/json" --data @"$f"
          done

      - name: Install Locust
        run: |
          pip install locust

      - name: Run Locust load test
        run: |
          locust -f examples/locust/locustfile.py --headless -u 20 -r 5 -t 2m --host http://localhost:8081 --only-summary