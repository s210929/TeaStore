name: Recommender Build

on:
  workflow_dispatch

jobs:
  build:
    name: Build recommender with WireMock
    runs-on: ubuntu-latest

    services:
      wiremock:
        image: wiremock/wiremock:3.3.1
        ports:
          - 8080:8080
        options: >-
          --health-cmd "wget -qO- http://localhost:8080/__admin/mappings || exit 1"
          --health-interval 5s
          --health-timeout 2s
          --health-retries 10
          -v ${{ github.workspace }}/.github/wiremock/mappings:/home/wiremock/mappings:ro

    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Build recommender with mocked services
        env:
          TEASTORE_REGISTRY_URL: http://localhost:8080
          TEASTORE_PERSISTENCE_URL: http://localhost:8080
        run: |
          mvn clean install -pl services/tools.descartes.teastore.recommender -am

          GIT_BRANCH=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
          echo "GIT_BRANCH=${GIT_BRANCH}" >> ${GITHUB_ENV}

          sed -i "s/teastore-base:latest/teastore-base:${GIT_BRANCH}/g" services/tools.descartes.teastore.recommender/Dockerfile

      - name: Build teastore-recommender Docker image
        uses: docker/build-push-action@v2
        with:
          context: ./services/tools.descartes.teastore.recommender
          push: false
          tags: descartesresearch/teastore-recommender:${{ env.GIT_BRANCH }}
