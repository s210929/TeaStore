name: Recommender Build

on:
  workflow_dispatch

env:
  IMAGE_NAME: ghcr.io/s210929/teastore/teastore-recommender
  IMAGE_TAG: loadtest

jobs:
  build:
    name: Build recommender with WireMock
    runs-on: ubuntu-latest

    services:
      wiremock:
        image: wiremock/wiremock:3.3.1
        ports:
          - 8080:8080

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Upload WireMock mappings
        run: |
          for f in .github/wiremock/mappings/*.json; do
            curl -s -X POST http://localhost:8080/__admin/mappings \
              -H "Content-Type: application/json" \
              --data @"$f"
          done    

      - name: Build recommender with mocked services
        env:
          TEASTORE_REGISTRY_URL: http://localhost:8080
          TEASTORE_PERSISTENCE_URL: http://localhost:8080
        run: |
          mvn clean install \
            -pl services/tools.descartes.teastore.recommender \
            -am

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push teastore-recommender Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/tools.descartes.teastore.recommender
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  loadtest:
    name: Locust load test
    runs-on: ubuntu-latest
    needs: build

    services:
      wiremock:
        image: wiremock/wiremock:3.3.1
        ports:
          - 8080:8080

    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start recommender container
        run: |
          docker run -d \
            --name teastore-recommender \
            -p 8081:8080 \
            -e TEASTORE_REGISTRY_URL=http://host.docker.internal:8080 \
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Upload WireMock mappings
        run: |
          for f in .github/wiremock/mappings/*.json; do
            curl -s -X POST http://localhost:8080/__admin/mappings \
              -H "Content-Type: application/json" \
              --data @"$f"
          done

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'    

      - name: Install Locust
        run: |
          python -m pip install --upgrade pip
          python -m pip install "locust[fast]"
      
      - name: Test recommender endpoint
        run: |
          curl -X POST "http://localhost:8081/recommendsingle?uid=1" \
            -H "Content-Type: application/json" \
            -d '{"productId":1,"quantity":1}'

      - name: Run Locust load test
        run: |
          locust \
            -f examples/locust/locust_recommender.py \
            --headless \
            -u 20 \
            -r 5 \
            -t 1m \
            --host http://localhost:8081
